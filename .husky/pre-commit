#!/bin/bash
set -e

echo "ğŸ” Running pre-commit checks..."

# Security check - scan for secrets and sensitive data
echo "ğŸ”’ Running security checks..."
if command -v gitleaks &> /dev/null; then
    echo "  â€¢ Scanning for secrets with gitleaks..."
    gitleaks detect --source . --verbose || {
        echo "âŒ Secret detection failed! Please review and fix any detected secrets."
        echo "ğŸ’¡ Use 'git secret' or replace with placeholders for test data."
        exit 1
    }
else
    echo "  â€¢ gitleaks not found, skipping secret scan (install with: brew install gitleaks)"
fi

# Check for private keys (excluding test patterns and detectors)
echo "  â€¢ Checking for private keys..."
if grep -r "BEGIN PRIVATE KEY\|BEGIN RSA PRIVATE KEY\|BEGIN OPENSSH PRIVATE KEY" --include="*.ts" --include="*.js" --include="*.json" src/ tests/ 2>/dev/null | grep -v "pattern:" | grep -v "test.*key.*:" | grep -v "example.*key" | grep -v "placeholder" | grep -v "detector" | grep -v "\.test\." | grep -v "//.*BEGIN"; then
    echo "âŒ Real private keys detected! Remove them before committing."
    echo "ğŸ’¡ Test patterns and detectors are allowed."
    exit 1
fi

# Run lint-staged for formatting
echo "ğŸ¨ Running code formatting..."
npx lint-staged

# Run typecheck
echo "ğŸ” Running TypeScript check..."
npm run typecheck

# Build the project
echo "ğŸ”¨ Building project..."
npm run build

# Run a quick smoke test to ensure basic functionality
echo "ğŸ§ª Running smoke test..."
npx vitest run tests/smoke.test.ts --passWithNoTests

echo "âœ… Pre-commit checks completed!"