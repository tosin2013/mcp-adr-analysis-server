#!/bin/bash
set -e

echo "ğŸš€ Running pre-push checks..."

# Final security check before push
echo "ğŸ”’ Final security scan..."
if command -v gitleaks &> /dev/null; then
    echo "  â€¢ Running comprehensive secret scan..."
    gitleaks detect --source . --verbose || {
        echo "âŒ Security scan failed! Cannot push with potential secrets."
        exit 1
    }
else
    echo "  â€¢ gitleaks not found, install with: brew install gitleaks"
fi

# Check for dependency vulnerabilities
echo "ğŸ›¡ï¸  Checking dependencies for vulnerabilities..."
npm audit --audit-level moderate || {
    echo "âš ï¸  High/critical vulnerabilities found. Consider running 'npm audit fix'"
    echo "ğŸ“ You can still push, but please address vulnerabilities soon."
}

# Run node compatibility check if Makefile exists
if [ -f "Makefile" ]; then
    echo "ğŸ“¦ Checking Node.js compatibility..."
    make node-compat || echo "âš ï¸  Node compatibility check failed, but continuing"
fi

# Build check
echo "ğŸ”¨ Final build check..."
npm run build || {
    echo "âŒ Build failed! Cannot push broken build."
    exit 1
}

# Run test suite (allow some failures for performance tests)
echo "ğŸ§ª Running test suite..."
if npm run test; then
    echo "âœ… All tests passed!"
else
    echo "âš ï¸  Some tests failed, but continuing (performance tests have known issues)"
    echo "ğŸ“ Please investigate test failures when possible"
fi

echo "âœ… Pre-push checks completed!"