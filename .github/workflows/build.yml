name: Build and Package

on:
  push:
    branches: [ main ]
    tags: [ 'v*' ]
  pull_request:
    branches: [ main ]

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '18'
        cache: 'npm'

    - name: Install dependencies
      run: npm ci

    - name: Build project
      run: npm run build

    - name: Verify build output
      run: |
        if [ ! -f "dist/src/index.js" ]; then
          echo "❌ Build failed - dist/src/index.js not found"
          exit 1
        fi
        echo "✅ Build successful - dist/src/index.js created"

    - name: Test built MCP server
      run: |
        echo "Testing built MCP server..."
        
        # Test that the built server can start
        timeout 10s node dist/index.js --help || true
        
        # Verify the built server has all expected tools
        cat > verify-build.js << 'EOF'
        const fs = require('fs');
        const path = require('path');
        
        // Check if all expected files exist
        const expectedFiles = [
          'dist/src/index.js',
          'dist/src/types/index.js',
          'dist/src/utils/file-system.js',
          'dist/src/tools/project-analysis-tool.js'
        ];
        
        let allFilesExist = true;
        expectedFiles.forEach(file => {
          if (!fs.existsSync(file)) {
            console.log(`❌ Missing file: ${file}`);
            allFilesExist = false;
          }
        });
        
        if (allFilesExist) {
          console.log('✅ All expected build files present');
        } else {
          console.log('❌ Build verification failed');
          process.exit(1);
        }
        
        // Check that the main index.js has MCP server code
        const indexContent = fs.readFileSync('dist/src/index.js', 'utf8');
        if (indexContent.includes('McpAdrAnalysisServer') && indexContent.includes('tools/list')) {
          console.log('✅ Built server contains expected MCP functionality');
        } else {
          console.log('❌ Built server missing expected MCP functionality');
          process.exit(1);
        }
        EOF
        
        node verify-build.js

    - name: Package for distribution
      if: startsWith(github.ref, 'refs/tags/')
      run: |
        # Create distribution package
        mkdir -p package
        cp -r dist package/
        cp package.json package/
        cp README.md package/
        cp LICENSE package/ || echo "No LICENSE file found"
        
        # Create tarball
        tar -czf mcp-adr-analysis-server-${{ github.ref_name }}.tar.gz -C package .

    - name: Upload build artifacts
      uses: actions/upload-artifact@v4
      with:
        name: build-artifacts
        path: |
          dist/
          package.json
        retention-days: 30

    - name: Upload distribution package
      if: startsWith(github.ref, 'refs/tags/')
      uses: actions/upload-artifact@v4
      with:
        name: distribution-package
        path: mcp-adr-analysis-server-*.tar.gz
        retention-days: 90
